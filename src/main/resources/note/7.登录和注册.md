# EasyChat 登录和注册流程详解

## 1. 概述

本文档详细介绍了EasyChat系统的用户注册和登录流程，包括接口说明、方法调用链路以及相关实体类的作用。

## 2. 流程图

### 2.1 用户注册流程图

```mermaid
graph TD
    A[用户填写注册信息] --> B[前端请求/checkCode获取验证码]
    B --> C[后端生成验证码并存储到Redis]
    C --> D[返回验证码图片给前端]
    D --> E[用户填写注册表单并提交]
    E --> F[前端调用/register接口]
    F --> G{验证码校验}
    G -->|错误| H[返回验证码错误]
    G -->|正确| I[调用UserInfoService.register()]
    I --> J{检查邮箱是否存在}
    J -->|存在| K[抛出"用户已存在"异常]
    J -->|不存在| L{检查是否有靓号}
    L -->|有靓号| M[使用靓号作为用户ID]
    L -->|无靓号| N[生成随机用户ID]
    M --> O[构造用户信息对象]
    N --> O[构造用户信息对象]
    O --> P[保存用户信息到数据库]
    P --> Q[返回注册成功]
```

### 2.2 用户登录流程图

```mermaid
graph TD
    A[用户填写登录信息] --> B[前端请求/checkCode获取验证码]
    B --> C[后端生成验证码并存储到Redis]
    C --> D[返回验证码图片给前端]
    D --> E[用户填写登录表单并提交]
    E --> F[前端调用/login接口]
    F --> G{验证码校验}
    G -->|错误| H[返回验证码错误]
    G -->|正确| I[调用UserInfoService.login()]
    I --> J{检查用户是否存在}
    J -->|不存在| K[抛出"用户不存在"异常]
    J -->|存在| L{校验密码}
    L -->|错误| M[抛出"密码错误"异常]
    L -->|正确| N{检查用户状态}
    N -->|禁用| O[抛出"用户被禁用"异常]
    N -->|正常| P{检查是否已在别处登录}
    P -->|是| Q[抛出"已在别处登录"异常]
    P -->|否| R[生成Token]
    R --> S[保存用户信息到Redis]
    S --> T[封装UserInfoVo对象]
    T --> U[返回登录成功及用户信息]
```

## 3. 接口详细说明

### 3.1 获取验证码接口

- **接口地址**: `/account/checkCode`
- **请求方式**: GET
- **功能说明**: 生成算术验证码图片和答案，存储到Redis中并返回给前端
- **返回内容**:
  - checkCode: 验证码图片(Base64编码)
  - checkCodeKey: 验证码键值，用于后续验证

### 3.2 用户注册接口

- **接口地址**: `/account/register`
- **请求方式**: POST
- **请求参数**:
  - checkCodeKey: 验证码键值
  - email: 用户邮箱
  - password: 用户密码
  - nickName: 用户昵称
  - checkCode: 用户输入的验证码
- **功能说明**: 完成用户注册流程
- **处理流程**:
  1. 验证验证码是否正确
  2. 调用 [UserInfoService.register()](file:///D:/chat_learn/easychat-java/src/main/java/com/itzpy/service/UserInfoService.java#L107-L117) 方法完成注册
  3. 清除验证码缓存

### 3.3 用户登录接口

- **接口地址**: `/account/login`
- **请求方式**: POST
- **请求参数**:
  - checkCodeKey: 验证码键值
  - email: 用户邮箱
  - password: 用户密码
  - checkCode: 用户输入的验证码
- **功能说明**: 完成用户登录流程
- **处理流程**:
  1. 验证验证码是否正确
  2. 调用 [UserInfoService.login()](file:///D:/chat_learn/easychat-java/src/main/java/com/itzpy/service/UserInfoService.java#L112-L117) 方法完成登录
  3. 清除验证码缓存

## 4. 核心方法调用链路

### 4.1 注册流程方法调用

1. [AccountController.register()](file:///D:/chat_learn/easychat-java/src/main/java/com/itzpy/controller/AccountController.java#L82-L99)
   - 接收前端注册请求
   - 验证验证码
   - 调用 [UserInfoService.register()](file:///D:/chat_learn/easychat-java/src/main/java/com/itzpy/service/UserInfoService.java#L107-L117)

2. [UserInfoServiceImpl.register()](file:///D:/chat_learn/easychat-java/src/main/java/com/itzpy/service/impl/UserInfoServiceImpl.java#L225-L273)
   - 检查邮箱是否已存在
   - 生成用户ID（优先使用靓号）
   - 构造 [UserInfo](file:///D:/chat_learn/easychat-java/src/main/java/com/itzpy/entity/po/UserInfo.java#L13-L86) 对象
   - 保存到数据库

### 4.2 登录流程方法调用

1. [AccountController.login()](file:///D:/chat_learn/easychat-java/src/main/java/com/itzpy/controller/AccountController.java#L119-L134)
   - 接收前端登录请求
   - 验证验证码
   - 调用 [UserInfoService.login()](file:///D:/chat_learn/easychat-java/src/main/java/com/itzpy/service/UserInfoService.java#L112-L117)

2. [UserInfoServiceImpl.login()](file:///D:/chat_learn/easychat-java/src/main/java/com/itzpy/service/impl/UserInfoServiceImpl.java#L274-L309)
   - 根据邮箱查询用户
   - 验证密码
   - 检查用户状态
   - 检查是否已在别处登录
   - 生成Token并保存到Redis
   - 封装 [UserInfoVo](file:///D:/chat_learn/easychat-java/src/main/java/com/itzpy/entity/vo/UserInfoVo.java#L8-L62) 返回给前端

## 5. 关键实体类说明

### 5.1 UserInfo（用户信息实体类）

位于: [com.itzpy.entity.po.UserInfo](file:///D:/chat_learn/easychat-java/src/main/java/com/itzpy/entity/po/UserInfo.java#L13-L86)

表示系统中的用户信息，对应数据库中的 `user_info` 表。

主要字段:
- userId: 用户ID
- email: 用户邮箱
- nickname: 用户昵称
- password: 用户密码(MD5加密)
- status: 用户状态
- createTime: 创建时间

### 5.2 UserInfoVo（用户信息视图对象）

位于: [com.itzpy.entity.vo.UserInfoVo](file:///D:/chat_learn/easychat-java/src/main/java/com/itzpy/entity/vo/UserInfoVo.java#L8-L62)

用于向前端返回用户信息的视图对象，包含了登录成功后需要返回的所有信息。

主要字段:
- token: 用户登录凭证
- admin: 是否为管理员
- 其他与 [UserInfo](file:///D:/chat_learn/easychat-java/src/main/java/com/itzpy/entity/po/UserInfo.java#L13-L86) 相同的字段

### 5.3 TokenUserInfoDto（Token用户信息传输对象）

位于: `com.itzpy.entity.dto.TokenUserInfoDto`

用于在Redis中存储用户登录信息的DTO对象。

主要字段:
- token: 用户凭证
- userId: 用户ID
- nickName: 用户昵称
- admin: 是否为管理员

## 6. 关键技术点

### 6.1 密码加密

使用MD5算法对用户密码进行加密存储，防止密码泄露。

### 6.2 Token生成与验证

模拟JWT方式生成Token，由用户ID和随机字符串组成，经过MD5加密后作为Token。

### 6.3 验证码机制

使用 `ArithmeticCaptcha` 生成算术验证码，防止机器人注册和登录。

### 6.4 防重复登录

通过Redis存储用户心跳时间，检测用户是否已在别处登录。

### 6.5 靓号机制

用户可以拥有靓号ID，注册时会优先使用靓号作为用户ID。

## 7. 异常处理

系统中定义了多种业务异常情况：
- 图片验证码错误
- 用户已存在
- 用户不存在
- 密码错误
- 用户被禁用
- 用户已在别处登录

所有异常都会通过全局异常处理器统一处理并返回给前端。