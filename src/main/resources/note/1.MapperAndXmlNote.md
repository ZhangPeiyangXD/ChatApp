# 项目中XML文件和BaseMapper接口语法详解

## 一、BaseMapper接口分析

BaseMapper.java是通用的基础Mapper接口，它定义了基本的CRUD（创建、读取、更新、删除）操作方法，为所有实体提供统一的数据访问接口。

### 方法列表及作用说明

| 方法名 | 参数 | 返回值 | 作用说明 |
|-------|------|--------|---------|
| selectList | @Param("query") P p | List<T> | 根据查询参数获取实体对象列表 |
| selectCount | @Param("query") P p | Integer | 根据查询参数统计符合条件的记录总数 |
| insert | @Param("bean") T t | Integer | 插入单条记录 |
| insertOrUpdate | @Param("bean") T t | Integer | 插入或更新单条记录（使用ON DUPLICATE KEY UPDATE） |
| insertBatch | @Param("list") List<T> list | Integer | 批量插入记录 |
| insertOrUpdateBatch | @Param("list") List<T> list | Integer | 批量插入或更新记录 |
| updateByParam | @Param("bean") T t, @Param("query") P p | Integer | 根据查询条件更新符合条件的记录 |
| deleteByParam | @Param("query") P p | Integer | 根据查询条件删除符合条件的记录 |

## 二、BaseMapperTableSplit接口分析

BaseMapperTableSplit.java是支持分表操作的Mapper接口，与BaseMapper接口功能相似，但增加了表名参数，适用于需要进行水平分表的场景。

### 方法列表及作用说明

| 方法名 | 参数 | 返回值 | 作用说明 |
|-------|------|--------|---------|
| selectList | @Param("tableName")String tableName, @Param("query") P p | List<T> | 根据表名和查询参数获取实体对象列表 |
| selectCount | @Param("tableName")String tableName, @Param("query") P p | Integer | 根据表名和查询参数统计记录数量 |
| insert | @Param("tableName")String tableName, @Param("bean") T t | Integer | 向指定表插入单条记录 |
| insertOrUpdate | @Param("tableName")String tableName, @Param("bean") T t | Integer | 向指定表插入或更新单条记录 |
| insertBatch | @Param("tableName")String tableName, @Param("list") List<T> list | Integer | 向指定表批量插入记录 |
| insertOrUpdateBatch | @Param("tableName")String tableName, @Param("list") List<T> list | Integer | 向指定表批量插入或更新记录 |
| updateByParam | @Param("tableName")String tableName, @Param("bean") T t, @Param("query") P p | Integer | 在指定表中根据查询条件更新记录 |
| deleteByParam | @Param("tableName")String tableName, @Param("query") P p | Integer | 在指定表中根据查询条件删除记录 |

## 三、XML文件语法分析

### 1. MyBatis XML基本结构

在MyBatis中，XML映射文件用于配置SQL语句和结果映射。每个XML文件都有一个根元素`<mapper>`，通过namespace属性关联到对应的Mapper接口。

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itzpy.mappers.XXXMapper">
    <!-- SQL语句和映射配置 -->
</mapper>
```

### 2. 主要元素说明

#### `<resultMap>` - 结果映射
将数据库列映射到Java对象属性，解决数据库字段名与Java属性名不一致的问题：
```xml
<resultMap id="base_result_map" type="com.itzpy.entity.po.UserInfo">
    <result column="user_id" property="userId"/>
    <result column="email" property="email"/>
</resultMap>
```

#### `<sql>` - SQL片段
定义可重用的SQL片段，提高代码复用性：
```xml
<sql id="base_column_list">
    SELECT u.user_id, u.email FROM user_info u
</sql>

<!-- 引用方式 -->
<include refid="base_column_list"/>
```

#### `<select>` - 查询语句
执行SELECT操作，返回查询结果：
```xml
<select id="selectList" resultMap="base_result_map">
    SELECT <include refid="base_column_list"/>
    FROM user_info u
    <include refid="query_condition"/>
</select>
```

#### `<insert>` - 插入语句
执行INSERT操作，插入新记录：
```xml
<insert id="insert" parameterType="com.itzpy.entity.po.UserInfo">
    INSERT INTO user_info
    <trim prefix="(" suffix=")" suffixOverrides=",">
        <if test="bean.userId != null">user_id,</if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
        <if test="bean.userId!=null">#{bean.userId},</if>
    </trim>
</insert>
```

#### `<update>` - 更新语句
执行UPDATE操作，更新已有记录：
```xml
<update id="updateByParam" parameterType="com.itzpy.entity.query.UserInfoQuery">
    UPDATE user_info u
    <set>
        <if test="bean.userId != null">user_id = #{bean.userId},</if>
    </set>
    <include refid="query_condition"/>
</update>
```

#### `<delete>` - 删除语句
执行DELETE操作，删除记录：
```xml
<delete id="deleteByParam">
    delete u from user_info u
    <include refid="query_condition"/>
</delete>
```

### 3. 条件判断语法

#### `<if>` 标签
根据条件决定是否包含某段SQL，实现动态SQL：
```xml
<if test="query.userId != null and query.userId!=''">
    and u.user_id = #{query.userId}
</if>
```

#### `<where>` 标签
自动处理WHERE子句，智能去除多余的AND/OR关键字：
```xml
<where>
    <include refid="base_condition_filed"/>
    <if test="query.userIdFuzzy!= null and query.userIdFuzzy!=''">
        and u.user_id like concat('%', #{query.userIdFuzzy}, '%')
    </if>
</where>
```

#### `<trim>` 标签
用于处理SQL片段前缀、后缀和去除多余字符：
```xml
<trim prefix="(" suffix=")" suffixOverrides=",">
    <if test="bean.userId != null">user_id,</if>
</trim>
```

#### `<foreach>` 标签
用于遍历集合，常用于批量操作：
```xml
<foreach collection="list" item="item" separator=",">
    (#{item.userId}, #{item.email})
</foreach>
```

### 4. 特殊语法

#### 日期处理
使用CDATA段处理特殊字符，结合数据库函数处理日期：
```xml
<![CDATA[ and u.last_login_time>=str_to_date(#{query.lastLoginTimeStart}, '%Y-%m-%d') ]]>
```

#### 模糊查询
使用concat函数实现模糊匹配：
```xml
and u.user_id like concat('%', #{query.userIdFuzzy}, '%')
```

#### ON DUPLICATE KEY UPDATE
MySQL特有语法，用于插入或更新操作：
```xml
on DUPLICATE key update
<trim prefix="" suffix="" suffixOverrides=",">
    <if test="bean.userId!=null">user_id = VALUES(user_id),</if>
</trim>
```

## 四、总结

本项目采用MyBatis框架进行数据持久化操作，通过BaseMapper和BaseMapperTableSplit两个基础接口提供了通用的CRUD操作能力。XML文件中使用了丰富的MyBatis标签来构建动态SQL，能够灵活地处理各种复杂查询场景，特别是支持模糊查询、条件查询、批量操作等功能。

分表接口(BaseMapperTableSplit)为需要水平拆分的表提供了额外的支持，可以在运行时动态指定操作的表名，满足大数据量场景下的性能需求。