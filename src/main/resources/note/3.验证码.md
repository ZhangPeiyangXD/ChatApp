# 验证码接口实现流程

## 概述

本文档详细说明了 EasyChat 项目中获取验证码接口的实现流程。该接口用于生成算术验证码图片，并将验证码答案存储到 Redis 中以便后续验证。

## 接口实现流程

### 1. 控制器入口

验证码接口位于 AccountController 类中，通过 `/account/checkCode` 路径访问。

### 2. 验证码生成步骤

1. 使用 ArithmeticCaptcha 类创建一个算术验证码实例（在AccountController第28行）：
   ```java
   ArithmeticCaptcha captcha = new ArithmeticCaptcha(100, 42);
   ```

2. 获取验证码的答案文本：
   ```java
   String code = captcha.text();
   ```

3. 生成唯一的验证码标识符：
   ```java
   String checkCodeKey = UUID.randomUUID().toString();
   ```

4. 将验证码答案存储到 Redis 中：
   - Key：使用常量 `Constants.REDIS_KEY_CHECK_CODE`（值为 "easychat:checkCode"）
   - Value：验证码答案
   - 过期时间：10分钟（Constants.REDIS_TIME_1MIN * 10，即 600 秒）
   
   ```java
   redisUtils.setex(Constants.REDIS_KEY_CHECK_CODE, code, Constants.REDIS_TIME_1MIN * 10);
   ```

5. 生成验证码的 Base64 图片：
   ```java
   String checkCodeBase64 = captcha.toBase64();
   ```

6. 构造响应结果：
   ```java
   Map<String, String> result = new HashMap<>();
   result.put("checkCode", checkCodeBase64);
   result.put("checkCodeKey", checkCodeKey);
   ```

### 3. 响应结构

接口返回一个 ResponseVO 对象（定义在ResponseVO.java文件中），其中包含：
- status：状态（"success"）
- code：响应码（200）
- info：响应信息（"请求成功"）
- data：Map类型的数据，包含：
  - checkCode：Base64编码的验证码图片
  - checkCodeKey：验证码的唯一标识符

## 关键组件说明

### 1. ArithmeticCaptcha
第三方验证码库，用于生成算术类型的验证码图片。构造时指定图片宽高（100x42像素）。

### 2. RedisUtils
自定义工具类，封装了 Redis 的常用操作。在此处使用 setex 方法（定义在RedisUtils.java文件的第26-33行）存储带过期时间的验证码。

### 3. Constants
定义了系统常量：
- REDIS_KEY_CHECK_CODE："easychat:checkCode" 作为 Redis 存储验证码的键前缀
- REDIS_TIME_1MIN：60 秒，作为时间单位

## 总结

验证码接口的整体流程如下：
1. 客户端请求获取验证码
2. 服务端生成算术验证码及答案
3. 答案存储到 Redis 并设置 10 分钟过期时间
4. 返回验证码图片（Base64）和唯一标识给客户端
5. 用户在登录时输入验证码，前端携带 checkCodeKey 提交
6. 后端根据 checkCodeKey 从 Redis 中取出正确答案进行校验